WITH MAST AS (
SELECT CAR_ID, CAR_TYPE, (DAILY_FEE * 30) AS FEE, (
        SELECT DISCOUNT_RATE
          FROM CAR_RENTAL_COMPANY_DISCOUNT_PLAN T2
         WHERE T1.CAR_TYPE = T2.CAR_TYPE
           AND DURATION_TYPE LIKE '30%'
    ) AS RATE
  FROM CAR_RENTAL_COMPANY_CAR T1
 WHERE CAR_ID NOT IN (
 SELECT DISTINCT CAR_ID
   FROM CAR_RENTAL_COMPANY_RENTAL_HISTORY
  WHERE TO_CHAR(END_DATE,'YYYY-MM-DD') >= '2022-11-01'
    AND TO_CHAR(START_DATE,'YYYY-MM-DD') <= '2022-11-30'
 )
)
SELECT CAR_ID, CAR_TYPE, ROUND(FEE * ((100-RATE)/100)) AS FEE
  FROM MAST
 WHERE ROUND(FEE * ((100-RATE)/100)) BETWEEN 500000 AND 2000000
 ORDER BY 3 DESC, 2 ASC, 1 DESC;